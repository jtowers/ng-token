<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/ngToken.TimeoutManager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/ngToken.TimeoutManager.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(function () {
    var app = angular.module('ngToken.TimeoutManager', ['ngToken.Provider', 'ngIdle']);
    /**
     * @ngdoc service
     * @name $tokenTimeout
     * @description
     *     Keeps track of user activity and broadcasts event and removes tokens from storage on session end
     */
    app.factory('$tokenTimeout', function ($idle, $token, $window, $rootScope, $document) {
        var timeout = {};

        timeout.lastActivity = new Date();

        /**
         * @ngdoc method
         * @name $tokenTimeout#checkIdle
         * @params {Integer} countdown Seconds to session timeout
         * @description
         *     Checks to make sure a token exists and that there isn't activity from another tab. Broadcasts a countdown event if the user is genuinely idle.
         */
        timeout.checkIdle = function (countdown) {
            if($token.getCachedToken()) {
                if(Date.parse($token.$storage.lastTouch) &lt;= this.lastActivity) {
                    $rootScope.$broadcast('$tokenWarn', countdown);
                } else {
                    this.resetIdle();
                }
            }
        };

        /**
         * @ngdoc method
         * @name $tokenTimeout#resetIdle
         * @description Resets the ng-idle's watch and broadcasts a reset event
         */
        timeout.resetIdle = function () {
            $idle.unwatch();
            $idle.watch();
            $rootScope.$broadcast('$tokenResetIdle');
        };

        /**
         * @ngdoc method
         * @name $tokenTimeout#watch
         * @description Starts the watch and sets event ng-idle event listeners
         */
        timeout.watch = function () {
            var self = this;
            $idle.watch();

            $rootScope.$on('startIdle', self.resetIdle());

            $document.on($idle._options().events, function () {
                var newdate = new Date();
                $token.$storage.lastTouch = newdate;
                self.lastActivity = newdate;
            });

            $rootScope.$on('$idleWarn', function (e, countdown) {
                self.checkIdle(countdown);
            });

            $rootScope.$on('$idleTimeout', function () {
                $token.sessionExpired();
                self.resetIdle();
                $rootScope.$broadcast('$tokenExpired');
            });

            $rootScope.$on('$keepalive', function () {
                $token.keepAlive();
            });
        };

        return timeout;
    });
})();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>service</h3><ul><li><a href="$token.html">$token</a></li><li><a href="$tokenTimeout.html">$tokenTimeout</a></li><li><a href="$tokenUser.html">$tokenUser</a></li><li><a href="ngToken.Intercept.html">Intercept</a></li></ul><h3>provider</h3><ul><li><a href="$tokenProvider.html">$tokenProvider</a></li></ul><h3>module</h3><ul><li><a href="ngToken.html">ngToken</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> 
    using <a href="https://github.com/allenhwkim/angularjs-google-maps/tree/master/config/jsdoc/template">custom template </a> and 
    <a href="https://raw.githubusercontent.com/allenhwkim/angularjs-google-maps/master/config/jsdoc/plugins/angular.js">custom tag @ngdoc</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
<script>
  var href=window.location.href.match(/\/([^\/]+$)/)[1];
  document.querySelector("nav a[href='"+href+"']").scrollIntoView(true);
  if (window.location.hash == "")
    document.querySelector("body").scrollIntoView(true);
</script>
</body>
</html>
